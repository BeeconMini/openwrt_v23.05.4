From: 张 鹏 <sd20@qxwlan.com>
Date: Sun, 7 June 2023 09:32:28 -0700
Subject: [PATCH] ath79: enable link state reporting

Tested on Qxwlan e750a e600g e600gac and ml181(qca9561)

Link: https://github.com/openwrt/openwrt/pull/9971
Signed-off-by:张 鹏 <sd20@qxwlan.com>

--- a/drivers/net/ethernet/atheros/ag71xx/ag71xx.h
+++ b/drivers/net/ethernet/atheros/ag71xx/ag71xx.h
@@ -160,6 +160,7 @@
 	u16			rx_buf_size;
 	u8			rx_buf_offset;
 	u8			tx_hang_workaround:1;
+	u8			builtin_switch:1;
 
 	struct net_device	*dev;
 	struct platform_device  *pdev;
--- a/drivers/net/ethernet/atheros/ag71xx/ag71xx_main.c
+++ b/drivers/net/ethernet/atheros/ag71xx/ag71xx_main.c
@@ -867,6 +867,8 @@
 	u32 cfg2;
 	u32 ifctl;
 	u32 fifo5;
+	u32 speed;
+	u32 duplex;
 
 	if (!ag->link && update) {
 		ag71xx_hw_stop(ag);
@@ -880,9 +882,13 @@
 	    !of_device_is_compatible(np, "qca,ar7100-eth"))
 		ag71xx_fast_reset(ag);
 
+	duplex = ag-> duplex;
+	if (ag->builtin_switch)
+		duplex = 1;
+
 	cfg2 = ag71xx_rr(ag, AG71XX_REG_MAC_CFG2);
 	cfg2 &= ~(MAC_CFG2_IF_1000 | MAC_CFG2_IF_10_100 | MAC_CFG2_FDX);
-	cfg2 |= (ag->duplex) ? MAC_CFG2_FDX : 0;
+	cfg2 |= (duplex) ? MAC_CFG2_FDX : 0;
 
 	ifctl = ag71xx_rr(ag, AG71XX_REG_MAC_IFCTL);
 	ifctl &= ~(MAC_IFCTL_SPEED);
@@ -890,7 +896,11 @@
 	fifo5 = ag71xx_rr(ag, AG71XX_REG_FIFO_CFG5);
 	fifo5 &= ~FIFO_CFG5_BM;
 
-	switch (ag->speed) {
+	speed = ag->speed;
+	if (ag->builtin_switch)
+		speed = SPEED_1000;
+
+	switch (speed) {
 	case SPEED_1000:
 		cfg2 |= MAC_CFG2_IF_1000;
 		fifo5 |= FIFO_CFG5_BM;
@@ -1583,6 +1593,10 @@
 		ag->pllregmap = NULL;
 	}
 
+	if (of_property_read_bool(np, "builtin-switch")) {
+		ag->builtin_switch = 1;
+	}
+
 	ag->mac_base = devm_ioremap(&pdev->dev, res->start,
 				    res->end - res->start + 1);
 	if (!ag->mac_base)
